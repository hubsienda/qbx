<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>QBX Weather — Exact Condition Game</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="description" content="Guess the exact live weather condition from WeatherAPI. Type a city, get options, test your meteorological wit.">

<!-- Canonical -->
<link rel="canonical" href="https://weather.qbx.app">

<!-- Open Graph / Twitter -->
<meta property="og:url" content="https://weather.qbx.app">
<meta property="og:title" content="QBX Weather — Exact Condition Game">
<meta property="og:description" content="Guess the exact live weather condition from WeatherAPI. Type a city, get options, test your meteorological wit.">
<meta property="og:type" content="website">
<meta property="og:image" content="https://raw.githubusercontent.com/hubsienda/qbx/refs/heads/main/og-weather.png">
<meta property="og:image:type" content="image/png">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta name="twitter:card" content="summary_large_image">

<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111}
  .wrap{max-width:900px;margin:0 auto;padding:18px}
  h1{margin:0 0 8px}
  .lead{color:#666;margin:0 0 14px}
  .panel{background:#fff;border:1px solid #e6e6ef;border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  input,button{border-radius:10px;padding:10px 12px;font-weight:600}
  input{border:1px solid #d7d7de;min-width:240px;flex:1}
  button{border:0;background:#111;color:#fff;cursor:pointer}
  button:hover{background:#222}
  .ghost{background:#eee;color:#111}
  .ghost:hover{background:#ddd}
  .choices{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-top:10px}
  .status{font-size:14px;color:#666;margin-top:6px}
  .status.ok{color:#127a2a;font-weight:700}
  .status.bad{color:#b3261e;font-weight:700}
  .city{font-weight:800;margin:8px 0}
  .result{margin-top:10px;font-size:16px}
  .result.ok{color:#127a2a;font-weight:700}
  .result.bad{color:#b3261e;font-weight:700}
  .scorebar{display:flex;gap:14px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .scorebar strong{font-size:17px}
  details{margin-top:8px}
  pre{background:#111;color:#fff;padding:10px;border-radius:8px;white-space:pre-wrap;overflow:auto}
  .small{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="wrap">
  <h1>QBX Weather — Exact Condition</h1>
  <p class="lead">Type any city (or postcode, or <code>lat,lon</code>). We fetch the live weather and you guess the <em>exact</em> condition from WeatherAPI.</p>

  <section class="panel">
    <div class="row">
      <input id="q" type="text" placeholder='e.g. "New York", "SW1A", or "41.9028,12.4964"'>
      <button id="go">Fetch weather</button>
      <button id="random" class="ghost">Surprise me</button>
    </div>
    <div id="status" class="status">Idle. Enter a place and press “Fetch weather”.</div>
  </section>

  <section class="panel" id="game" style="display:none">
    <div class="city" id="cityName">—</div>
    <div class="small" id="meta">—</div>

    <div id="choices" class="choices"></div>
    <div id="result" class="result"></div>

    <div class="scorebar">
      <div><strong>Score:</strong> <span id="score">0</span></div>
      <div><strong>Streak:</strong> <span id="streak">0</span></div>
      <div><strong>Best:</strong> <span id="best">0</span></div>
      <button id="again" class="ghost">Next round (same place)</button>
      <button id="againRandom" class="ghost">Next round (random)</button>
      <button id="reset" class="ghost">Reset score</button>
    </div>

    <details>
      <summary class="small">Debug (raw WeatherAPI response)</summary>
      <pre id="debug">—</pre>
    </details>
  </section>

  <p class="small">Powered by <a href="https://www.weatherapi.com/" title="Weather API">WeatherAPI.com</a></p>
</div>

<script>
// ===== CONFIG =====
var API_KEY = "553b39e4a880493f8fe80855252108"; // your key
var SUGGEST = ["Rome","London","New York","Paris","Berlin","Tokyo","Sydney","Mexico City","Cairo","Athens","Bangkok","Toronto","Dublin","Lisbon","Istanbul","Cape Town","Reykjavik","Wellington","Delhi","Jakarta"];

// Plausible decoy condition texts (WeatherAPI style)
var DECOYS = [
  "Sunny","Partly cloudy","Cloudy","Overcast","Mist","Fog",
  "Patchy rain possible","Light rain","Moderate rain","Heavy rain",
  "Patchy light drizzle","Light drizzle","Light snow","Moderate snow",
  "Heavy snow","Thundery outbreaks possible","Patchy light rain with thunder",
  "Blowing snow","Sleet","Freezing drizzle","Light showers","Moderate or heavy rain shower"
];

// Elements
var qInput = document.getElementById('q');
var goBtn  = document.getElementById('go');
var rndBtn = document.getElementById('random');
var statusEl = document.getElementById('status');
var gameEl = document.getElementById('game');
var cityNameEl = document.getElementById('cityName');
var metaEl = document.getElementById('meta');
var choicesEl = document.getElementById('choices');
var resultEl = document.getElementById('result');
var debugEl = document.getElementById('debug');
var scoreEl = document.getElementById('score');
var streakEl = document.getElementById('streak');
var bestEl = document.getElementById('best');
var againBtn = document.getElementById('again');
var againRndBtn = document.getElementById('againRandom');
var resetBtn = document.getElementById('reset');

// State
var current = null; // {q, correctText}
var score = 0, streak = 0, best = 0;

// Persisted score (optional)
try {
  var s = JSON.parse(localStorage.getItem('qbx_wx_score') || 'null');
  if (s && typeof s.score==='number') { score=s.score; streak=s.streak||0; best=s.best||0; }
} catch(e){}

function saveScore(){
  try { localStorage.setItem('qbx_wx_score', JSON.stringify({score:score, streak:streak, best:best})); } catch(e){}
}

// Helpers
function setStatus(msg, ok){
  statusEl.textContent = msg;
  statusEl.className = "status" + (ok===true ? " ok" : ok===false ? " bad" : "");
}
function trim(s){ return (s||"").replace(/^\s+|\s+$/g,""); }
function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(a){ for(var i=a.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=a[i]; a[i]=a[j]; a[j]=t; } return a; }
function renderScore(){ scoreEl.textContent=score; streakEl.textContent=streak; bestEl.textContent=best; }

// XHR helper (ES5)
function xhrGet(url, cb){
  var x = new XMLHttpRequest();
  x.open("GET", url, true);
  x.onreadystatechange = function(){ if (x.readyState===4) cb(null, x.status, x.responseText); };
  x.onerror = function(e){ cb(e || new Error("Network error")); };
  x.send();
}

function buildChoices(correctText){
  var cLower = correctText.toLowerCase();
  var decoys = [];
  var tries = 0;
  while(decoys.length<2 && tries<80){
    var d = rand(DECOYS);
    if (d.toLowerCase() !== cLower && decoys.indexOf(d)===-1) decoys.push(d);
    tries++;
  }
  var options = shuffle([correctText].concat(decoys));
  choicesEl.innerHTML = "";
  for (var i=0;i<options.length;i++){
    (function(opt){
      var b = document.createElement("button");
      b.className = "ghost";
      b.textContent = opt;
      b.onclick = function(){ onGuess(opt, correctText); };
      choicesEl.appendChild(b);
    })(options[i]);
  }
}

function onGuess(choice, correct){
  if(!current){ return; }
  if(choice === correct){
    score++; streak++; if(streak>best) best=streak;
    resultEl.className = "result ok";
    resultEl.textContent = 'Correct! It is "' + correct + '".';
  } else {
    streak = 0;
    resultEl.className = "result bad";
    resultEl.textContent = 'Wrong. Actual: "' + correct + '".';
  }
  renderScore();
  saveScore();
}

function fetchWeather(q){
  setStatus('Fetching "'+q+'" ...');
  resultEl.textContent = "";
  choicesEl.innerHTML = "";
  gameEl.style.display = "block";
  cityNameEl.textContent = q;
  metaEl.textContent = "—";
  debugEl.textContent = "—";

  var url = "https://api.weatherapi.com/v1/current.json"
          + "?key=" + encodeURIComponent(API_KEY)
          + "&q="   + encodeURIComponent(q)
          + "&aqi=no"
          + "&_="   + Date.now(); // cache-buster

  xhrGet(url, function(err, status, body){
    if(err){ setStatus("Network error", false); debugEl.textContent=String(err); return; }
    if(String(status).charAt(0) !== "2"){ setStatus("HTTP "+status+" — see Debug", false); debugEl.textContent=body; return; }

    var data;
    try { data = JSON.parse(body); } catch(e){ setStatus("Parse error — see Debug", false); debugEl.textContent=body; return; }

    if(!data || !data.current || !data.location || !data.current.condition){
      setStatus("Unexpected API shape — see Debug", false); debugEl.textContent=body; return;
    }

    var cond = data.current.condition;       // exact WeatherAPI condition
    var correctText = String(cond.text);
    var loc = data.location;

    // meta
    var nameBits = [];
    if(loc.name) nameBits.push(loc.name);
    if(loc.region) nameBits.push(loc.region);
    if(loc.country) nameBits.push(loc.country);
    var fullName = nameBits.join(", ");

    metaEl.textContent = (fullName || q)
      + ' — API: "' + correctText + '" (code ' + cond.code + '), '
      + 'Temp ' + data.current.temp_c + '°C • Local ' + (loc.localtime || "-");

    debugEl.textContent = body;

    buildChoices(correctText);
    setStatus("Live weather loaded", true);
    current = { q:q, correctText:correctText };
  });
}

// Wire up
document.getElementById("go").addEventListener("click", function(){
  var q = trim(qInput.value);
  if(!q){ setStatus("Please type a place.", false); return; }
  fetchWeather(q);
});
qInput.addEventListener("keydown", function(ev){
  if(ev.key === "Enter" || ev.keyCode === 13) document.getElementById("go").click();
});
rndBtn.addEventListener("click", function(){
  var pick = rand(SUGGEST);
  qInput.value = pick;
  fetchWeather(pick);
});
againBtn.addEventListener("click", function(){
  if(current && current.q) fetchWeather(current.q);
});
againRndBtn.addEventListener("click", function(){
  var pick = rand(SUGGEST);
  qInput.value = pick;
  fetchWeather(pick);
});
resetBtn.addEventListener("click", function(){
  score=0; streak=0; best=0; renderScore(); saveScore();
  resultEl.textContent = "";
  setStatus("Score reset.");
});

// Init score UI
renderScore();
</script>
</body>
</html>

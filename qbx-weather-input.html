<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>QBX Weather Reality Check</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  body{font-family:system-ui,Arial,sans-serif;margin:0;background:#f6f6f8;color:#111}
  .wrap{max-width:980px;margin:0 auto;padding:18px}
  h1{margin:0 0 10px}
  .panel{background:#fff;border:1px solid #e5e5ee;border-radius:12px;padding:12px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{border-radius:10px;padding:9px 12px;font-weight:600}
  input{border:1px solid #d7d7de;min-width:220px;flex:1}
  button{border:0;background:#111;color:#fff;cursor:pointer}
  button:hover{background:#222}
  .ghost{background:#eee;color:#111}
  .ghost:hover{background:#ddd}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #eee;padding:8px 6px;text-align:left;font-size:14px}
  th{background:#fafafd}
  .muted{color:#666}
  .ok{color:#127a2a;font-weight:700}
  .bad{color:#b3261e;font-weight:700}
  code{background:#f0f0f4;padding:2px 4px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <h1>QBX Weather Reality Check</h1>
  <div class="panel">
    <div class="row">
      <input id="q" type="text" placeholder='e.g. "New York", "SW1A", or "41.9028,12.4964"'>
      <button id="add">Add</button>
      <button id="presets" class="ghost">Load presets</button>
      <button id="clear" class="ghost">Clear</button>
      <span id="status" class="muted">Ready.</span>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th><th>Query</th><th>Resolved location</th><th>Cond text</th><th>Code</th><th>Bucket</th><th>Temp °C</th><th>Local time</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <p class="muted" style="margin-top:8px">Powered by <a href="https://www.weatherapi.com/" title="Weather API">WeatherAPI.com</a></p>
  </div>
</div>

<script>
// ===== CONFIG =====
var API_KEY = "553b39e4a880493f8fe80855252108";
// ==================

// Mapping: WeatherAPI condition.code -> our 6 buckets (code-only; no text guessing)
function mapToBucket(code){
  code = parseInt(code,10);
  // Storms / thunder
  if (code === 1087 || (code >= 1273 && code <= 1282)) return 'Stormy';
  // Rain & drizzle (incl. freezing)
  if (code === 1063) return 'Rainy';
  if (code >= 1150 && code <= 1171) return 'Rainy';
  if (code >= 1180 && code <= 1201) return 'Rainy';
  if (code >= 1240 && code <= 1246) return 'Rainy';
  // Snow / sleet / ice pellets / blizzard
  if (code === 1066 || code === 1069) return 'Snowy';
  if (code === 1114 || code === 1117) return 'Snowy';
  if (code >= 1204 && code <= 1207) return 'Snowy';
  if (code >= 1210 && code <= 1237) return 'Snowy';
  if (code >= 1249 && code <= 1264) return 'Snowy';
  // Fog / mist
  if (code === 1030 || code === 1135 || code === 1147) return 'Foggy';
  // Clouds
  if (code === 1003 || code === 1006 || code === 1009) return 'Cloudy';
  // Clear
  if (code === 1000) return 'Sunny';
  // Default
  return 'Cloudy';
}

// XHR helper (ES5)
function xhrGet(url, cb){
  var x = new XMLHttpRequest();
  x.open('GET', url, true);
  x.onreadystatechange = function(){ if (x.readyState === 4) cb(null, x.status, x.responseText); };
  x.onerror = function(e){ cb(e || new Error('Network error')); };
  x.send();
}

var tbody = document.getElementById('tbody');
var statusEl = document.getElementById('status');
var qInput = document.getElementById('q');
var addBtn = document.getElementById('add');
var presetsBtn = document.getElementById('presets');
var clearBtn = document.getElementById('clear');

var rowCount = 0;

function setStatus(msg, cls){
  statusEl.textContent = msg;
  statusEl.className = (cls||'muted');
}

function addRow(data, q){
  rowCount += 1;
  var tr = document.createElement('tr');

  function td(txt, cls){
    var el = document.createElement('td');
    el.textContent = txt;
    if (cls) el.className = cls;
    return el;
  }

  if (!data || !data.current || !data.location || !data.current.condition){
    tr.appendChild(td(String(rowCount)));
    tr.appendChild(td(q || '—'));
    tr.appendChild(td('—'));
    tr.appendChild(td('ERROR', 'bad'));
    tr.appendChild(td('—'));
    tr.appendChild(td('—'));
    tr.appendChild(td('—'));
    tr.appendChild(td('—'));
    tbody.appendChild(tr);
    return;
  }

  var loc = data.location;
  var cur = data.current;
  var cond = cur.condition;
  var bucket = mapToBucket(cond.code);

  var resolved = [];
  if (loc.name)   resolved.push(loc.name);
  if (loc.region) resolved.push(loc.region);
  if (loc.country)resolved.push(loc.country);

  tr.appendChild(td(String(rowCount)));
  tr.appendChild(td(q));
  tr.appendChild(td(resolved.join(', ')));
  tr.appendChild(td(cond.text));
  tr.appendChild(td(String(cond.code)));
  tr.appendChild(td(bucket));
  tr.appendChild(td(String(cur.temp_c)));
  tr.appendChild(td(loc.localtime || '—'));
  tbody.appendChild(tr);
}

function fetchOne(q){
  setStatus('Fetching "'+q+'" …');
  var url = 'https://api.weatherapi.com/v1/current.json'
          + '?key=' + encodeURIComponent(API_KEY)
          + '&q='   + encodeURIComponent(q)
          + '&aqi=no'
          + '&_='   + Date.now();

  xhrGet(url, function(err, status, body){
    if (err){ setStatus('Network error', 'bad'); addRow(null, q); return; }
    if (String(status).charAt(0) !== '2'){ setStatus('HTTP '+status+' — see console', 'bad'); try{console.log(body);}catch(e){} addRow(null, q); return; }
    var json;
    try{ json = JSON.parse(body); }catch(e){ setStatus('Parse error', 'bad'); addRow(null, q); return; }
    addRow(json, q);
    setStatus('Done.');
  });
}

addBtn.onclick = function(){
  var q = (qInput.value || '').replace(/^\s+|\s+$/g,'');
  if(!q){ setStatus('Type a place first', 'bad'); return; }
  fetchOne(q);
};

qInput.addEventListener('keydown', function(ev){
  if (ev.key === 'Enter' || ev.keyCode === 13) addBtn.click();
});

presetsBtn.onclick = function(){
  var list = ["Rome","London","New York","Paris","Berlin","Tokyo","Sydney","Cairo","Mexico City","Toronto","Athens","Bangkok","Dublin","Lisbon","Istanbul","Cape Town","Reykjavik","Wellington","Delhi","Jakarta"];
  for (var i=0;i<list.length;i++) fetchOne(list[i]);
};

clearBtn.onclick = function(){ tbody.innerHTML=''; rowCount=0; setStatus('Cleared.'); };
</script>
</body>
</html>

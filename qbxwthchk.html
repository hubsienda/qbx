<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>QBX Weather Guess — Any City</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="Guess the weather in any city. Powered by WeatherAPI.">
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      margin: 0;
      background: #f7f7f8;
      color: #111;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 18px;
    }
    h1 {
      font-size: 32px;
      margin: 0 0 8px;
    }
    .lead {
      color: #666;
      margin: 0 0 14px;
    }
    .panel {
      background: #fff;
      border: 1px solid #e9e9ee;
      border-radius: 14px;
      padding: 14px;
      margin: 12px 0;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    input, button {
      border-radius: 10px;
      padding: 10px 12px;
      font-weight: 600;
    }
    input {
      border: 1px solid #d7d7de;
      flex: 1;
      min-width: 220px;
    }
    button {
      border: 0;
      background: #111;
      color: #fff;
      cursor: pointer;
    }
    button:hover {
      background: #222;
    }
    .ghost {
      background: #eee;
      color: #111;
      border: 0;
    }
    .ghost:hover {
      background: #ddd;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .city {
      font-size: 22px;
      font-weight: 800;
      margin: 10px 0;
    }
    .status {
      font-size: 14px;
      margin-top: 6px;
      color: #666;
    }
    .status.ok {
      color: #127a2a;
      font-weight: 700;
    }
    .status.bad {
      color: #b3261e;
      font-weight: 700;
    }
    .result {
      margin-top: 10px;
      font-size: 16px;
    }
    .result.ok {
      color: #127a2a;
      font-weight: 700;
    }
    .result.bad {
      color: #b3261e;
      font-weight: 700;
    }
    .score {
      margin-top: 10px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    .score strong {
      font-size: 17px;
    }
    details {
      margin-top: 6px;
    }
    pre {
      background: #111;
      color: #fff;
      padding: 10px;
      border-radius: 8px;
      white-space: pre-wrap;
      overflow: auto;
    }
    .small {
      font-size: 13px;
      color: #666;
      text-align: center;
    }
    footer {
      text-align: center;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>QBX Weather Guess</h1>
    <p class="lead">Type any city (or postcode, or "lat,lon"), fetch live weather, then guess.</p>

    <section class="panel">
      <div class="row">
        <input id="q" type="text" placeholder='e.g. "New York", "SW1A", or "41.9028,12.4964"'>
        <button id="go">Fetch weather</button>
        <button id="random" class="ghost">Surprise me</button>
      </div>
      <div id="status" class="status">Idle. Enter a place and press "Fetch weather".</div>
    </section>

    <section class="panel" id="game" style="display:none">
      <div class="city" id="cityName">—</div>
      <div class="small" id="meta">—</div>

      <div class="grid">
        <button class="ghost" id="gSunny">Sunny</button>
        <button class="ghost" id="gCloudy">Cloudy</button>
        <button class="ghost" id="gRainy">Rainy</button>
        <button class="ghost" id="gSnowy">Snowy</button>
        <button class="ghost" id="gStormy">Stormy</button>
        <button class="ghost" id="gFoggy">Foggy</button>
      </div>

      <div id="result" class="result"></div>

      <div class="score">
        <div><strong>Score:</strong> <span id="score">0</span></div>
        <div><strong>Streak:</strong> <span id="streak">0</span></div>
        <div><strong>Best:</strong> <span id="best">0</span></div>
        <button id="again" class="ghost">Fetch again</button>
      </div>

      <details>
        <summary class="small">Debug (raw WeatherAPI response)</summary>
        <pre id="debug">—</pre>
      </details>
    </section>

    <footer>
      <p class="small">
        Made with ❤️ at QBX Labs - 
        <a href="https://sienda.co.uk" target="_blank" rel="noopener">Sienda Ltd</a> 
        London, UK
      </p>
      <p class="small">
        Powered by <a href="https://www.weatherapi.com/" title="Weather API" target="_blank" rel="noopener">WeatherAPI.com</a>
      </p>
    </footer>
  </div>

  <script>
    // ===== CONFIG =====
    var API_KEY = "553b39e4a880493f8fe80855252108"; // Replace with your real key if needed
    var SUGGEST = [
      "Rome", "London", "Madrid", "Paris", "Berlin",
      "New York", "Tokyo", "Sydney", "Mexico City", "Cairo",
      "Athens", "Bangkok", "Toronto", "Dublin", "Lisbon",
      "Istanbul", "Rio de Janeiro", "Cape Town", "Reykjavik", "Wellington"
    ];
    // ==================

    // Elements
    var qInput = document.getElementById('q');
    var goBtn  = document.getElementById('go');
    var rndBtn = document.getElementById('random');
    var statusEl = document.getElementById('status');

    var gameEl = document.getElementById('game');
    var cityNameEl = document.getElementById('cityName');
    var metaEl = document.getElementById('meta');
    var resultEl = document.getElementById('result');
    var debugEl = document.getElementById('debug');

    var scoreEl = document.getElementById('score');
    var streakEl = document.getElementById('streak');
    var bestEl = document.getElementById('best');
    var againBtn = document.getElementById('again');

    var btns = {
      Sunny:  document.getElementById('gSunny'),
      Cloudy: document.getElementById('gCloudy'),
      Rainy:  document.getElementById('gRainy'),
      Snowy:  document.getElementById('gSnowy'),
      Stormy: document.getElementById('gStormy'),
      Foggy:  document.getElementById('gFoggy')
    };

    // State
    var score = 0, streak = 0, best = 0;
    var currentQ = null, currentCat = null, canGuess = false;

    // Helpers
    function setStatus(msg, ok) {
      statusEl.textContent = msg;
      statusEl.className = 'status' + (ok === true ? ' ok' : ok === false ? ' bad' : '');
    }
    function renderScore() {
      scoreEl.textContent = score;
      streakEl.textContent = streak;
      bestEl.textContent = best;
    }
    function rand(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
    function trim(s) { return (s || '').replace(/^\s+|\s+$/g, ''); }

    // Map WeatherAPI condition code to category
    function mapToCat(code) {
      code = parseInt(code, 10);
      if (code === 1000) return 'Sunny'; // Clear
      if ([1003, 1006, 1009].includes(code)) return 'Cloudy'; // Partly cloudy, overcast
      if (code >= 1063 && code <= 1072) return 'Rainy'; // Drizzle
      if (code >= 1150 && code <= 1189) return 'Rainy'; // Rain, showers
      if (code >= 1192 && code <= 1240) return 'Rainy'; // Heavy rain
      if (code >= 1114 && code <= 1117) return 'Snowy'; // Snow in patches
      if (code >= 1204 && code <= 1237) return 'Snowy'; // Sleet, snow
      if (code >= 1249 && code <= 1264) return 'Snowy'; // Ice, sleet showers
      if (code >= 1087 && code <= 1087) return 'Stormy'; // Thunder
      if (code >= 1273 && code <= 1282) return 'Stormy'; // Thunder with rain/snow
      if (code >= 1030 && code <= 1030) return 'Foggy'; // Mist
      if (code >= 1135 && code <= 1145) return 'Foggy'; // Fog
      return 'Cloudy'; // Fallback
    }

    // XHR (ES5-safe)
    function xhrGet(url, cb) {
      var x = new XMLHttpRequest();
      x.open('GET', url, true);
      x.onreadystatechange = function () {
        if (x.readyState === 4) cb(null, x.status, x.responseText);
      };
      x.onerror = function (e) { cb(e || new Error('Network error')); };
      x.send();
    }

    function fetchWeather(q) {
      currentQ = q;
      setStatus('Fetching weather for "' + q + '" ...');
      resultEl.textContent = '';
      metaEl.textContent = '—';
      debugEl.textContent = '—';
      gameEl.style.display = 'block';
      cityNameEl.textContent = q;

      var url = 'https://api.weatherapi.com/v1/current.json' +
        '?key=' + encodeURIComponent(API_KEY) +
        '&q=' + encodeURIComponent(q) +
        '&aqi=no' +
        '&_=' + Date.now(); // Cache buster

      xhrGet(url, function (err, status, body) {
        if (err) {
          setStatus('Network error', false);
          debugEl.textContent = String(err);
          canGuess = false;
          return;
        }
        debugEl.textContent = body;

        if (String(status).charAt(0) !== '2') {
          setStatus('HTTP ' + status + ' — see Debug', false);
          canGuess = false;
          return;
        }

        var data;
        try {
          data = JSON.parse(body);
        } catch (e) {
          setStatus('Parse error — see Debug', false);
          canGuess = false;
          return;
        }

        if (!data || !data.current || !data.current.condition || !data.location) {
          setStatus('Unexpected API response — see Debug', false);
          canGuess = false;
          return;
        }

        var cond = data.current.condition;
        var loc = data.location;
        currentCat = mapToCat(cond.code);

        var nameBits = [];
        if (loc.name) nameBits.push(loc.name);
        if (loc.region) nameBits.push(loc.region);
        if (loc.country) nameBits.push(loc.country);
        var fullName = nameBits.join(', ');

        metaEl.textContent = (fullName || q)
          + ' — API: "' + cond.text + '" (code ' + cond.code + '), '
          + 'Temp ' + data.current.temp_c + '°C • Local ' + (loc.localtime || '-');

        setStatus('Live weather loaded', true);
        canGuess = true;
      });
    }

    function onGuess(cat) {
      if (!canGuess) return;
      canGuess = false;
      if (cat === currentCat) {
        score++;
        streak++;
        if (streak > best) best = streak;
        resultEl.className = 'result ok';
        resultEl.textContent = 'Correct! It is ' + currentCat + ' in ' + currentQ + '.';
      } else {
        streak = 0;
        resultEl.className = 'result bad';
        resultEl.textContent = 'Wrong. Actual: ' + currentCat + '.';
      }
      renderScore();
    }

    // Event Listeners
    goBtn.addEventListener('click', function () {
      var q = trim(qInput.value);
      if (!q) {
        setStatus('Please type a city/postcode/coords.', false);
        return;
      }
      fetchWeather(q);
    });

    qInput.addEventListener('keydown', function (ev) {
      if (ev.key === 'Enter' || ev.keyCode === 13) goBtn.click();
    });

    rndBtn.addEventListener('click', function () {
      var pick = rand(SUGGEST);
      qInput.value = pick;
      fetchWeather(pick);
    });

    againBtn.addEventListener('click', function () {
      if (currentQ) fetchWeather(currentQ);
    });

    Object.keys(btns).forEach(function (cat) {
      btns[cat].addEventListener('click', function () { onGuess(cat); });
    });

    // Init
    renderScore();
  </script>
</body>
</html>
